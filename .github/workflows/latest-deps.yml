name: Test Against Latest Dependencies

on:
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  latest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          persist-credentials: false

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5  # v6.2.0
        with:
          go-version-file: go.mod
          cache: false

      - uses: geomys/sandboxed-step@7d75eb49d17fdeeb3656b3a57d35932d205bcfb9  # v1.2.1
        with:
          run: |
            DIRECT=$(grep -E '^\s+\S+ v[0-9]' go.mod | grep -v '// indirect' | awk '{print $1}')
            UPGRADES=$(go get $(echo "$DIRECT" | awk '{print $1 "@latest"}') 2>&1 \
              | grep -E "^go: (upgraded|added)" \
              | while IFS= read -r line; do
                  pkg=$(echo "$line" | awk '{print $3}')
                  if echo "$DIRECT" | grep -qxF "$pkg"; then echo "$line"; fi
                done || true)
            go mod tidy
            {
              echo "### Direct Dependency Updates"
              echo ""
              if [ -z "$UPGRADES" ]; then
                echo "All direct dependencies are already at their latest versions."
              else
                echo "\`\`\`"
                echo "$UPGRADES"
                echo "\`\`\`"
              fi
            } | tee -a "${GITHUB_STEP_SUMMARY:-/dev/null}"
            go test ./...
